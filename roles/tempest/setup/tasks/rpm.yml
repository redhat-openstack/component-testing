- name: Install dependencies required to run Tempest
  become: true
  yum: state=present name={{ item }}
  with_items:
     - python-tox
     - python-ddt
     - python-testscenarios
     - python-jsonschema
     - python-subunit
     - python-os-testr
     - openstack-tempest
     - openstack-tempest-all

- name: Install dependencies for filtering and collecting logs
  become: true
  yum: state=present name={{ item }}
  with_items:
     - subunit-filters
     - python-junitxml

- name: Create tmp dir
  shell: mktemp -d
  register: random_tmp_dir

- name: Clone Red Hat Tempest repo
  git:
    repo="https://github.com/redhat-openstack/tempest.git"
    version="{{ rhos_upstream_map[component.version].release }}"
    dest="{{ random_tmp_dir.stdout_lines[0] }}"

- name: Create ~/tempest directory if not exists
  file:
    path=tempest
    state=directory

- name: Locate the script which configures the tempest directory
  shell: ls -d /usr/share/openstack-tempest-*/tools/configure-tempest-directory
  register: configure_tempest_dir
  ignore_errors: true

- name: Initialize tempest workspace directory
  command: "{{ configure_tempest_dir.stdout_lines[0] }}"
  args:
      chdir: "~/tempest"
      creates: "~/tempest/LICENSE"
  when: configure_tempest_dir.rc == 0

- name: Install tempestconf if config script is not part of tempest
  become: yes
  package:
      name: python-tempestconf
      state: present
  when: configure_tempest_dir.rc != 0

# For RHOS 11 this step fails with error message:
# Could not load oslo.i18n, oslo.serialization, oslo.utils
# Follow the: https://bugzilla.redhat.com/show_bug.cgi?id=1429465
- name: Initialize tempest workspace directory using tempest init
  command: "tempest init"
  args:
      chdir: "~/tempest"
      creates: "~/tempest/etc"
  when: configure_tempest_dir.rc != 0

- name: Check if we have tempestconf tool installed
  stat:
      path: /usr/bin/discover-tempest-config
  register: tempest_conf_tool

- name: Set facts for configuration run
  set_fact:
      config_command: /usr/bin/discover-tempest-config
  when: tempest_conf_tool.stat.exists

- name: Copy files required to setup virtual env to run the tempest configuration
  copy: remote_src=True src={{ random_tmp_dir.stdout_lines[0] }}/{{ item }}  dest=tempest
  with_items:
    - test-requirements.txt
    - requirements.txt