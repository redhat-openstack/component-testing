- name: Install needed RPMs for running tempest
  become: true
  become_method: sudo
  yum:
    name="{{ item }}"
    state=present
  with_items:
    - 'gcc'
    - 'libffi-devel'
    - 'openssl-devel'
    - 'subunit-filters'

- include: "{{ tempest_install_type }}.yml"

- debug: var=rc_file

- debug: var=overcloud_rc_file

- name: Ensures /home/stack/ dir exists
  file:
    path=/home/stack/
    state=directory
  become: true

- name: Copy keystonerc into /home/stack/stackrc
  copy:
    src="{{ inventory_dir }}/keystonerc"
    dest="{{ overcloud_rc_file }}"
    mode=0644
  become: true

- name: run tempest configuration tool
  shell: |
      source {{ overcloud_rc_file }}
      if [ -f venv ]; then
          source venv/bin/activate
      fi

      public_net_id=$(neutron net-show ${pool_name:-public} -f value -c id)

      neutron subnet-create \
        --name ext-subnet \
        --allocation-pool start=192.0.2.50,end=192.0.2.180 \
        --disable-dhcp --gateway 192.0.2.1 ${pool_name:-public} 192.0.2.0/24

      tools/config_tempest.py --out ~/.config/tempest/tempest.conf --network-id ${public_net_id} \
                              --debug --create identity.uri $OS_AUTH_URL \
                                identity.admin_password $OS_PASSWORD \
                                object-storage.operator_role swiftoperator \
                                orchestration.stack_owner_role heat_stack_owner \
                                compute.min_compute_nodes ${min_compute_nodes:-0} \
                                compute-feature-enabled.scheduler_available_filters ${nova_sched_filters:-RetryFilter,AvailabilityZoneFilter,RamFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,CoreFilter}
  args:
      chdir: "{{ tempest_install_path }}"
      creates: "~/.config/tempest/tempest.conf"

- name: set tempest_skipfile location
  set_fact:
    tempest_skipfile: "{{ ~/.config/tempest/skipfile }}"

# If no skipfile is present, tempest will fail to run
- name: Create empty skip file
  file:
    path="{{ tempest_skipfile | default(overcloud_skipfile) }}"
    state=touch
    mode=0555

- name: create skip list - Whitelist
  lineinfile:
    create: yes
    dest: "{{ tempest_skipfile | default(overcloud_skipfile) }}"
    line: "+{{ item }}"
    regexp: "^[-+]{{ item }}$"
  with_items: "{{ tempest.whitelist }}"
  when: tempest.whitelist is defined

- name: create skip list - Blacklist
  lineinfile:
    create: yes
    dest: "{{ tempest_skipfile | default(overcloud_skipfile) }}"
    line: "-{{ item }}"
    regexp: "^[-+]{{ item }}$"
  with_items: "{{ tempest.blacklist }}"
  when: tempest.blacklist is defined
