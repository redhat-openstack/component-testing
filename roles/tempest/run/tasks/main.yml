- name: Run testr init
  shell: |
    {{ tempest_venv_activate }}
    testr init
  args:
    creates: "{{ tempest_cwd }}/.testrepository"
    chdir: "{{ tempest_cwd }}"
  tags:
    - skip_ansible_lint

- name: Run component specific commands
  shell: "{{ component_config.run }}"
  args:
    chdir: "{{ component.name }}"
  changed_when: true
  tags:
    - skip_ansible_lint

- name: Run Tempest
  shell: |
    set -euo pipefail;
    {{ tempest_venv_activate }}
    ./tools/run-tests.sh --parallel {{ tempest_regex | default('') }} --skip-file ./skipfile | tee tempest.log | tail -n200
  args:
    chdir: "{{ tempest_cwd }}"
  ignore_errors: true
  tags:
    - skip_ansible_lint

- name: Fetch Tempest results
  fetch:
    src="{{ tempest_cwd }}/{{ item }}"
    dest="{{ lookup('env', 'PWD') }}/{{ item }}"
    flat=yes
  with_items:
    - tempest.xml
    - tempest.log
