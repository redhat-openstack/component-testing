# Tox (http://tox.testrun.org/) is a tool for running tests
# in multiple virtualenvs.
# This configuration file will run the test suite on all supported
# python versions.
# To use it, "pip install tox" and then run "tox" from this directory.

[tox]
envlist = py27,yamllint,flake8,ansible-lint,ansible-check,ansible-syntax-check,package
skipsdist = True

[testenv]
changedir = {toxinidir}
deps =
  -r{toxinidir}/requirements.txt
  -r{toxinidir}/requirements-test.txt
whitelist_externals = bash
passenv =
    SSH_AUTH_SOCK
    HOME
    USER
# SSH_AUTH_SOCK may be needed for allowing to use the agent
# HOME and USER are needed to run ansible playbooks
commands =
    ansible-playbook -v -i localhost, ./tests/sample.yml

[testenv:flake8]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    python -m flake8

[testenv:yamllint]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    {toxworkdir}/py27/bin/yamllint -f parsable .

[testenv:ansible-lint]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    /bin/bash -c 'ansible-lint -x ANSIBLE0010 {toxinidir}/playbooks/*.yml'

[testenv:ansible-check]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    - bash -c "ANSIBLE_FORCE_COLOR=false ansible-playbook -i tests/hosts -v playbooks/*.yml --check >ansible-check.log 2>&1 || echo 'WARN:	Failure ignored failure because CI currently does not allow sudo on slaves.'"

[testenv:ansible-syntax-check]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    /bin/bash -c "/usr/bin/find ./playbooks -name '*.yml' | /usr/bin/xargs -n1  ansible-playbook -i tests/hosts --syntax-check --list-tasks -v"

[testenv:package]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
     bash -c "python setup.py build sdist bdist_wheel check --restructuredtext --strict >tox-package.log"
