# Tox (http://tox.testrun.org/) is a tool for running tests
# in multiple virtualenvs.
# This configuration file will run the test suite on all supported
# python versions.
# To use it, "pip install tox" and then run "tox" from this directory.

[tox]
envlist = py27,yamllint,flake8,ansible-lint,ansible-check,ansible-syntax-check
skipsdist = True

[testenv]
sitepackages = True
changedir = {toxinidir}
deps =
  -r{toxinidir}/requirements.txt
  -r{toxinidir}/test-requirements.txt
whitelist_externals =
    bash
    which
commands =
    bash -c "./tests/sample.yml >/dev/null"
    # workaround for RHOSINFRA-699 : ir cannot be called from anywhere
    bash -c "cd `python -c 'import os, infrared; print(os.path.dirname(infrared.__file__))'`/.. && pwd && infrared octario --help >/dev/null"
passenv =
    SSH_AUTH_SOCK
    USER

[testenv:flake8]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    python -m flake8

[testenv:yamllint]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    bash -c "git ls-tree --full-tree --name-only -r HEAD . | grep -E '\.ya?ml$' | xargs python -m yamllint"

[testenv:ansible-lint]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    /bin/bash -c 'ansible-lint -x ANSIBLE0010 {toxinidir}/playbooks/*.yml'

[testenv:ansible-check]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    - bash -c "ANSIBLE_FORCE_COLOR=false ansible-playbook -i tests/hosts -v playbooks/*.yml --check >ansible-check.log 2>&1 || echo 'WARN:	Failure ignored failure because CI currently does not allow sudo on slaves.'"

[testenv:ansible-syntax-check]
basepython=python2.7
envdir = {toxworkdir}/py27
commands =
    /bin/bash -c "/usr/bin/find ./playbooks -name '*.yml' | /usr/bin/xargs -n1  ansible-playbook -i tests/hosts --syntax-check --list-tasks -v"
